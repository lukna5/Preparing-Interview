Во время выполнения транзакции __параллельные__ транзакции не должны оказывать влияния на её результат.
Одна транзакция **не должна мешать** другой. В PostgreSQL изолированность регулируется **уровнями изоляции**

В примеру будем разбирать на основе проведения параллельных операций двумя транзакциями X и Y на каком-то счете. Изначально на нем будет 500 рублей.

| Аномалия               | Проблема                                                                                                                                                                                                                                                          | Пример                                                                                                                                                                                                                                                                                          |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Потерянное обновление  | Две транзакции читают одну и ту же строку таблицы, затем одна транзакция обновляет эту строку, а после этого вторая транзакция __тоже обновляет ту же строку, не учитывая изменений, сделанных первой транзакцией.__                                              | 1) Со счета сняли 300 (стало 200) - X<br>2) На счет положили 300 (без учета снятия стало 800, так как о нем ничего не известно) - Y<br>3) На счету окажется 800                                                                                                                                 |
| Грязное чтение         | Транзакция читает __еще не зафиксированные изменения__, сделанные другой транзакцией.                                                                                                                                                                             | 1) Списывают 300 (без commit) - X<br>2) Читают, что на счету сейчас 200 - Y<br>3) Откатывают X из-за ошибки или чего-либо еще<br>4) На счету 500, Y получил неверные данные                                                                                                                     |
| Неповторяющееся чтение | Транзакция читает одну и ту же строку __два раза__, и в промежутке __между чтениями вторая транзакция изменяет__ (или удаляет) эту строку и фиксирует изменения. Тогда первая транзакция получит __разные результаты__.                                           | 1) Планируется снять со счета 100 . Проверяется, что на счете > 100 - X<br>2) Снимается со счета 500 (с коммитом) - Y<br>3) Снимается со счета 100 - X<br>4) На счету -100 рублей (что запрещено констреинтами)                                                                                 |
| Write skew             |                                                                                                                                                                                                                                                                   | Представим двух врачей, которые проверяют, дежурит ли кто-то:<br>Оба врача запускают транзакции, чтобы снять себя с дежурства, **если второй врач всё ещё дежурит**. <br>Оба увидят, что второй дежурит и оставят дежурство. В итоге **оба сняли себя с дежурства**, думая, что другой остался. |
| Фантомное чтение       | Транзакция __два раза читает набор строк по одному и тому же условию__, и в __промежутке__ между чтениями вторая транзакция __добавляет строки__, удовлетворяющие этому условию (и фиксирует изменения). Тогда первая транзакция получит __разные наборы строк.__ | 1) Клиенту можно иметь только 3 счета и у него их сейчас 2.<br>2) Клиент открывает счет, проверяется, что у него их всего 2 - X<br>3) Клиенту открылся новый счет (стало 3) - Y<br>4) Клиенту открылся новый счет (стало 4) - Y<br>5) Нарушено условие (макс 3 счета)                           |

### Уровни изоляции
Serializable Snapshot Isolation (SSI) — это **не блокировки**, а **анализ зависимостей**

| Уровни изоляции | Как работает                                                                                                                                                      | Как работает в PostgreSQL                                                                                                                                                                                                                                                                                                                                                                                            | Проще в PSQL                   | Минусы                                                                                                                                                                                 |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Read Uncommited | Транзакция блокирует __изменяемые__ строки от __изменения__                                                                                                       | Не поддерживается, используется Read Commited                                                                                                                                                                                                                                                                                                                                                                        |                                |                                                                                                                                                                                        |
| Read Commited   | Транзакция блокирует __изменяемые__ строки от __изменения и чтения__<br>(Транзакция видит только commited изменения других транзакций)                            | Каждый новый SQL-запрос в рамках одной транзакции видит только те данные, которые были зафиксированы (`COMMIT`) к моменту начала этого запроса.<br><br>Если другая транзакция изменит данные и зафиксирует изменения (`COMMIT`), то новый запрос внутри текущей транзакции (какой-то отдельный, пример: select, update, delete) уже увидит обновлённые данные перед вызовом.                                         | каждый запрос — новый snapshot | Данные могут “меняться на глазах” между `SELECT`                                                                                                                                       |
| Repeateble Read | Транзакция блокирует __изменяемые и читаемые__ строки от __изменения и чтения__<br>(Запрещает изменение данных, которые были прочитаны в рамках одной транзакции) | Все запросы внутри транзакции видят **снимок данных (snapshot), сделанный в момент начала транзакции**.<br><br>Если другая транзакция выполняет `UPDATE`, `DELETE` или `INSERT` после того, как наша транзакция начала работу, **эти изменения не будут видны в текущей транзакции**.<br><br>__Но новые строки могут появляться__                                                                                    | фиксируется при `BEGIN`        | Не защищает от write skew.<br><br>Надо держать **все строки**, видимые на момент начала, в MVCC.<br>__VACUUM не может почистить удерживаемы записи__                                   |
| Serializable    | Транзакции выполняются последовательно (или эмулируют последовательное выполнение)                                                                                | PostgreSQL использует **Serializable Snapshot Isolation (SSI)**, который отслеживает **конфликты зависимостей между транзакциями**<br>Если обнаруживается конфликт, который может привести к нарушению сериализуемости, одна из транзакций принудительно **откатывается (`ROLLBACK`)**.<br>Таким образом, поведение эквивалентно **последовательному выполнению транзакций**, даже если они исполняются параллельно. | + отслеживание зависимостей    | То же, что и Repeateble Read +<br>__Медленный и может откатывать транзакции__, потому что отслеживает логические зависимости и проверяет возможные конфликты между всеми транзакциями. |

## Табличка уровень изоляции - аномалия
