# –ò–¥–µ—è 
**MVCC** ‚Äî —ç—Ç–æ **Multi-Version Concurrency Control**, –∏–ª–∏  
**–ú–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º**.

> PostgreSQL –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∞ **—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏** —Å—Ç—Ä–æ–∫.  
> –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∏—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç.


# –ó–∞—á–µ–º –Ω—É–∂–µ–Ω MVCC?

### –ë–µ–∑ MVCC:
- –õ—é–±–æ–π `SELECT` –º–æ–≥ –±—ã –∂–¥–∞—Ç—å, –ø–æ–∫–∞ `UPDATE` –∏–ª–∏ `DELETE` –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç)
- –≠—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –±—ã –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º **–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º** –∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º
### –° MVCC:
- `SELECT` —á–∏—Ç–∞–µ—Ç **—Å–≤–æ—é ‚Äú—Å–Ω–∏–º–∫–æ–≤—É—é‚Äù –≤–µ—Ä—Å–∏—é** –¥–∞–Ω–Ω—ã—Ö (snapshot)
- `UPDATE`, `DELETE` —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, –∞ –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç —Å—Ç–∞—Ä—ã–µ
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî –Ω–µ –Ω—É–∂–Ω—ã!**

# –ú–µ—Ö–∞–Ω–∏–∑–º

## Xmin & Xmax

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ (tuple) –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–¥–µ—Ä–∂–∏—Ç **–¥–≤–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—è**:

| –ü–æ–ª–µ         | –ß—Ç–æ –∑–Ω–∞—á–∏—Ç                                             |
| ------------ | ------------------------------------------------------ |
| `xmin`       | ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è **—Å–æ–∑–¥–∞–ª–∞** —Å—Ç—Ä–æ–∫—É              |
| `xmax`       | ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è **—É–¥–∞–ª–∏–ª–∞ –∏–ª–∏ –æ–±–Ω–æ–≤–∏–ª–∞** —Å—Ç—Ä–æ–∫—É |
| xmax == null | –°—Ç—Ä–æ–∫–∞ –∂–∏–≤–∞                                            |
| xmax != null | –°—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–∏ / —É–¥–∞–ª–∏–ª–∏                          |

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `SELECT`:

–ö–æ–≥–¥–∞ —Ç—ã –≤—ã–ø–æ–ª–Ω—è–µ—à—å `SELECT`, PostgreSQL —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ `xmin/xmax` —Å—Ç—Ä–æ–∫–∏:
- –ï—Å–ª–∏ `xmin` > ID —Ç–≤–æ–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí —Å—Ç—Ä–æ–∫–∞ **–µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞** ‚Üí **–Ω–µ –≤–∏–¥–Ω–∞**
- –ï—Å–ª–∏ `xmax` –µ—Å—Ç—å –∏ ‚â§ —Ç–≤–æ–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí —Å—Ç—Ä–æ–∫–∞ **—É–∂–µ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞** ‚Üí **–Ω–µ –≤–∏–¥–Ω–∞**
- –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Üí —Å—Ç—Ä–æ–∫–∞ **–≤–∏–¥–Ω–∞**

> –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å "–≤–∏–¥–∏—Ç" **–º–∏—Ä, –∫–∞–∫ –æ–Ω –≤—ã–≥–ª—è–¥–µ–ª –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å snapshot.


## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ `UPDATE`?

- –°—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ **–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è** ‚Üí –æ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç `xmax = —Ç–µ–∫—É—â–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è`
- –°–æ–∑–¥–∞—ë—Ç—Å—è **–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞**:
    - `xmin = —Ç–µ–∫—É—â–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è`
    - `xmax = null`

–¢–∞–∫ PostgreSQL –º–æ–∂–µ—Ç **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å**:
- —Ç–µ—Ö, –∫—Ç–æ —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é,
- –∏ —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –≤–∏–¥–∏—Ç –Ω–æ–≤—É—é.

### –ö–æ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–º–µ—Ä—Ç–≤–æ–π‚Äù?

–ï—Å–ª–∏:
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, —É–∫–∞–∑–∞–Ω–Ω–∞—è –≤ `xmax`, —É–∂–µ **–∑–∞–≤–µ—Ä—à–µ–Ω–∞**
- –ò **–Ω–∏–∫—Ç–æ** (–Ω–∏ –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è) –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –µ—ë –≤–∏–¥–µ—Ç—å

üî∏ –¢–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è `VACUUM` –∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º–∏.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ MVCC

|–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ|–û–±—ä—è—Å–Ω–µ–Ω–∏–µ|
|---|---|
|‚ùå –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ —á—Ç–µ–Ω–∏–µ|`SELECT` –Ω–µ –º–µ—à–∞–µ—Ç `UPDATE`, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç|
|üß© –ü–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ —á—Ç–µ–Ω–∏—è (snapshot isolation)|–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç –±–∞–∑—É, –∫–∞–∫ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞|
|üìä –í—ã—Å–æ–∫–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å|–ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–µ—Å—è—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ|
|üîÑ –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å|–ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **—Å–≤–æ–µ–π –∫–æ–ø–∏–µ–π** —Å—Ç—Ä–æ–∫|

## –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ MVCC

| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫                           | –†–µ—à–µ–Ω–∏–µ                           |
| ------------------------------------ | --------------------------------- |
| üìà –†–æ—Å—Ç "–º–µ—Ä—Ç–≤—ã—Ö" —Å—Ç—Ä–æ–∫              | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `VACUUM`             |
| üì¶ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã        | `VACUUM FULL`, –∞–≤—Ç–æ–≤–∞–∫–∞—É–º         |
| üßπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å—Ç—Ä–æ–∫ | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å `autovacuum` –≥—Ä–∞–º–æ—Ç–Ω–æ |
|                                      |                                   |

## VACUUM
**VACUUM** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π **–æ—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö (–Ω–µ–≤–∏–¥–∏–º—ã—Ö) –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫**, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ `UPDATE` –∏–ª–∏ `DELETE`, –∏ **–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ** –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

- PostgreSQL –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ `UPDATE` –∏ `DELETE`.
- –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
    - `UPDATE` —Å–æ–∑–¥–∞—ë—Ç **–Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏**
    - —Å—Ç–∞—Ä–∞—è –ø–æ–ª—É—á–∞–µ—Ç `xmax = XID`
    - –æ–Ω–∞ **–æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ**, –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –µ—ë –º–æ–∂–µ—Ç "–≤–∏–¥–µ—Ç—å"
- –í –∏—Ç–æ–≥–µ: **—Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç—ë—Ç**, –¥–∞–∂–µ –µ—Å–ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤ –Ω–µ–π –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∏ **—Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É**
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - `xmax` (–∏–ª–∏ `xmin`) ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è?
    - –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏–º–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?
3. –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ **"–º–µ—Ä—Ç–≤–∞—è"** (–Ω–∏–∫–æ–º—É –±–æ–ª—å—à–µ –Ω–µ –≤–∏–¥–Ω–∞):
    - –ø–æ–º–µ—á–∞–µ—Ç –µ—ë –∫–∞–∫ **—É–¥–∞–ª—ë–Ω–Ω—É—é**
    - –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Å–ª–æ—Ç –≤ –±–ª–æ–∫–µ
    - __–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏__:
     "–í–æ—Ç —Ç—É—Ç –ª–µ–∂–∏—Ç –º—É—Å–æ—Ä, –º–æ–∂–µ—à—å –∑–∞—Ç–µ—Ä–µ—Ç—å –Ω–æ–≤—ã–º INSERT'–æ–º"
üî∏ –ù–æ: **–Ω–µ —É–¥–∞–ª—è–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∫—É –∏–∑ —Ñ–∞–π–ª–∞**  
üî∏ –ü—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ—Ç, —á—Ç–æ –µ—ë –º–æ–∂–Ω–æ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å**

### –¢–∏–ø—ã
| –¢–∏–ø VACUUM       | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                                      | –ë–ª–æ–∫–∏—Ä—É–µ—Ç? | –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ –≤ –û–°? | –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?                     |
| ---------------- | --------------------------------------------------------------- | ---------- | ----------------------- | ----------------------------------------- |
| `VACUUM`         | –û—á–∏—â–∞–µ—Ç "–º—ë—Ä—Ç–≤—ã–µ" —Å—Ç—Ä–æ–∫–∏, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ **–≤–Ω—É—Ç—Ä–∏** —Ç–∞–±–ª–∏—Ü—ã  | ‚ùå –ù–µ—Ç      | ‚ùå –ù–µ—Ç                   | ‚ùå –ù–µ—Ç                                     |
| `VACUUM ANALYZE` | –¢–æ –∂–µ —Å–∞–º–æ–µ, + –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤   | ‚ùå –ù–µ—Ç      | ‚ùå –ù–µ—Ç                   | ‚úÖ –î–∞                                      |
| `VACUUM FULL`    | –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É, —É–¥–∞–ª—è–µ—Ç –º—É—Å–æ—Ä, **—Å–∂–∏–º–∞–µ—Ç —Ñ–∞–π–ª**  | ‚úÖ –î–∞       | ‚úÖ –î–∞                    | ‚ùå –ù–µ—Ç (–∞–Ω–∞–ª–∏–∑ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ)                 |
| `AUTOVACUUM`     | –§–æ–Ω–æ–≤—ã–π VACUUM, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã | ‚ùå –ù–µ—Ç      | ‚ùå –ù–µ—Ç                   | –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ `autovacuum_analyze` —Å—Ä–∞–±–æ—Ç–∞–ª |
